# CSV to Markdown Converter (Gemini API版)

このプログラムは、CSVファイルの特定の列（生成結果列）を指定されたmarkdown形式に変換するツールです。Gemini APIを使用して、LLMによる高品質な変換を実行します。

## 機能

- CSVファイルの読み込み
- 生成結果列の自動検出
- Gemini APIを使用したLLMによるmarkdown形式への変換
- 指定された厳格なテンプレートへの完全一致
- 変換結果の新しいCSVファイルへの保存
- **ディレクトリに応じたGeminiモデルの自動選択**

## Geminiモデルの自動選択

プログラムは、実行されるディレクトリ名に基づいて適切なGeminiモデルを自動選択します：

### モデル選択ルール
- **`pro`ディレクトリ**: `gemini-1.5-pro` を使用
- **`flash`ディレクトリ**: `gemini-1.5-flash` を使用  
- **その他のディレクトリ**: `gemini-2.5-flash-lite` を使用（デフォルト）

### 使用例
```bash
# remake-mdディレクトリで実行 → gemini-2.5-flash-lite
cd remake-md
python convert_to_markdown.py

# proディレクトリで実行 → gemini-1.5-pro  
cd ../create-dailylog-pro
python convert_to_markdown.py

# flashディレクトリで実行 → gemini-1.5-flash
cd ../create-dailylog-flash
python convert_to_markdown.py
```

### モデル特性
- **`gemini-2.5-flash-lite`**: 高速・軽量、基本的な変換タスクに最適
- **`gemini-1.5-pro`**: 高精度・高品質、複雑な処理に最適
- **`gemini-1.5-flash`**: バランス型、速度と品質の両立

## 必要なライブラリ

```bash
pip install -r requirements.txt
```

## 環境変数の設定

Gemini APIを使用するために、以下の環境変数を設定する必要があります：

### Windows (PowerShell)
```powershell
$env:GEMINI_API_KEY="your_gemini_api_key_here"
```

### Windows (コマンドプロンプト)
```cmd
set GEMINI_API_KEY=your_gemini_api_key_here
```

### Linux/Mac
```bash
export GEMINI_API_KEY="your_gemini_api_key_here"
```

### APIキーの取得方法
1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. "Create API Key"をクリック
4. 生成されたAPIキーをコピーして環境変数に設定

## 使用方法

1. `input_data.csv`ファイルをremake-mdディレクトリに配置
2. 環境変数`GEMINI_API_KEY`を設定
3. 以下のコマンドでプログラムを実行：

```bash
python convert_to_markdown.py
```

4. エラー処理の選択肢が表示されます：
   - **オプション1**: エラーが発生した行をスキップして処理を続行
   - **オプション2**: エラーが発生したら処理を停止
5. 変換結果は`output.csv`として保存されます

## エラー処理

プログラムは、Gemini APIでエラーが発生した際に以下の処理を行います：

### エラー時の動作
- エラーが発生した行番号とエラー内容を表示
- 対象テキストの最初の100文字を表示
- ユーザーが選択したエラー処理方法に従って処理

### エラー処理の選択肢
1. **スキップして続行**: エラー行を空文字列にして処理を継続
2. **処理停止**: エラーが発生した時点で処理を完全に停止

### エラー情報の表示
- ❌ マークでエラー行を明確に表示
- エラーが発生した行の内容（最初の100文字）
- 詳細なエラーメッセージ
- 最終的な処理結果（成功・エラー・合計行数）

## 入力ファイルの要件

- CSVファイル形式
- UTF-8エンコーディング
- 以下の列のいずれかを含む必要があります：
  - `生成結果`
  - `事件の概要`
  - `概要`
  - `内容`

## 出力形式

各行の生成結果列が以下の厳格なmarkdownテンプレートに変換されます：

```markdown
## {事件の発生日}

### {エピソードタイトル}

### **導入 - その日の始まり**
（ここに「導入」セクションの本文を記述）

### **遭遇 - 事件の発生**
（ここに「遭遇」セクションの本文を記述）

### **捜査と観察 - 新一の視点**
（ここに「捜査と観察」セクションの本文を記述）

### **閃き - 真相への鍵**
（ここに「閃き」セクションの本文を記述）

### **真相解明 - 解決の舞台裏**
（ここに「真相解明」セクションの本文を記述）

### **結びと内省 - 事件の後で**
（ここに「結びと内省」セクションの本文を記述）
```

## 変換ルール

プログラムは以下の厳格なルールに従って変換を実行します：

- **見出しの正規化**: 日付は`##`形式、タイトルは`###`形式
- **セクション見出しの統一**: すべて`### **セクション名**`の形式
- **番号の削除**: `1.`、`2.`などの番号を完全に削除
- **空白行の統一**: 各見出しと本文の間に1行の空行
- **内容の保持**: 本文の内容は一切変更しない

## 注意事項

- 元のCSVファイルは変更されません
- 変換結果は新しいファイル（output.csv）として保存されます
- Gemini APIキーが必要です（無料枠あり）
- 大量のデータを処理する場合は時間がかかる場合があります
- エラーが発生した場合は、詳細なエラー情報が表示されます

## トラブルシューティング

### APIキーエラー
- 環境変数`GEMINI_API_KEY`が正しく設定されているか確認
- APIキーが有効かどうか確認

### 変換エラー
- 入力データの形式を確認
- ネットワーク接続を確認
